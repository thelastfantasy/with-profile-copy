name: Claude Auto Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 1

    - name: Run DeepSeek Code Review
      uses: anthropics/claude-code-action@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        anthropic_api_key: ${{ secrets.DEEPSEEK_API_KEY }}
        settings: |
          {
            "env": {
              "ANTHROPIC_BASE_URL": "https://api.deepseek.com/anthropic",
              "ANTHROPIC_AUTH_TOKEN": "${{ secrets.DEEPSEEK_API_KEY }}",
              "ANTHROPIC_MODEL": "deepseek-chat",
              "ANTHROPIC_SMALL_FAST_MODEL": "deepseek-chat",
              "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": "1",
              "API_TIMEOUT_MS": "600000"
            }
          }
        prompt: |
          REPO: ${{ github.repository }} PR NUMBER: ${{ github.event.pull_request.number }}

          请对本次提交中更改的文件进行简洁的代码审查。
          只关注实际修改的代码，不要审查未更改的文件。

          重要说明：
          - script.user.js 和 dist/ 目录下的文件是编译生成的内容，无需审查
          - 请重点关注 src/ 目录下的源代码文件

          审查重点：
          - 代码逻辑是否正确
          - 是否有明显的错误或潜在问题
          - 更改是否与PR描述一致
          - 是否有安全风险

          请使用 `gh pr comment` 提供总体反馈，使用 `mcp__github_inline_comment__create_inline_comment` 在具体代码位置添加行内评论。
          反馈要具体、简洁、实用。
        claude_args: |
          --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr view:*)"